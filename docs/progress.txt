## Codebase Patterns
- Use `getCurrentUserHouseholdId` from `src/server/household.ts` for household-scoped server logic.
- For filtered read server functions, use `inputValidator` and pass `{ data: {} }` when no filters are needed.
- `createServerFn` uses `.inputValidator`, not `.validator`, for input checks.
- `react-resizable-panels` exports `Group`/`Separator` (not `PanelGroup`/`PanelResizeHandle`) in this codebase.
- Reuse `getWeekDates`/`getDayKey` from `src/utils/date.ts` for week/day calculations.
- Calendar UI primitives live in `src/components/calendar` for reuse across views.
- Convex functions should reuse shared household scoping helpers from `convex/lib/household`.

## 2026-01-15 23:59 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added meal CRUD server functions with validation and household scoping.
- Files changed: `src/server/meals.ts`, `src/server/household.ts`, `docs/prds/MEALS_PRD.md`
- **Learnings for future iterations:**
  - Patterns discovered: Meal server functions follow the Tasks pattern with input validators and response mapping.
  - Gotchas encountered: Export the household helper instead of re-creating it in feature server modules.
  - Useful context: Meal responses use ISO date strings for frontend consumption.
---
## 2026-01-16 12:00 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Marked household helper reuse story complete; confirmed helper is defined in `src/server/household.ts` and used by meal server functions.
- Files changed: `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: `getCurrentUserHouseholdId` is the shared helper for household scoping across server modules.
  - Gotchas encountered: Ensure PRD stories include a `passes:` line when marking completion.
  - Useful context: Household membership lookup uses `clerkUserId` in `householdMember`.
---
## 2026-01-16 00:34 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Replaced local meal state with TanStack Query fetches/mutations, added loading/error UI, and wired add/delete to server functions.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-meals.test.tsx`, `docs/prds/MEALS_PRD.md`
- **Learnings for future iterations:**
  - Patterns discovered: For TanStack Query mutations, `createServerFn` receives an extra metadata argument in tests.
  - Gotchas encountered: Meal form labels need `htmlFor`/`id` pairing for RTL queries.
  - Useful context: Browser verification redirected to sign-in at `/sign-in?redirect=%2Fmeals`, so UI verification was blocked without credentials.
---
## 2026-01-16 11:55 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Switched meal day handling to use week-based Date objects, store local start-of-day ISO strings, and match meals by date keys; updated tests to use current-week dates.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-meals.test.tsx`, `docs/prds/MEALS_PRD.md`
- **Learnings for future iterations:**
  - Patterns discovered: Meal week rows derive from `startOfWeek(..., { weekStartsOn: 1 })` + `addDays` with local `startOfDay`.
  - Gotchas encountered: Meal rendering now depends on current-week dates, so tests should generate dates from `startOfWeek(new Date())` to stay deterministic.
  - Useful context: Browser verification still redirects to sign-in without credentials, blocking UI validation.
---
## 2026-01-16 11:58 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Verified the Meal Planning UI in the browser, confirmed weekday dropdown shows Monday-Sunday and add form fields render alongside the weekly grid.
- Files changed: `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Meal Planning UI renders add form inline below the header and uses accessible labels for Day/Meal Type/Meal Name.
  - Gotchas encountered: None.
  - Useful context: Browser verification passed at `/meals` with the current session.
---
## 2026-01-16 18:00 - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added week navigation with range label, scoped meal queries to the selected week, and kept add form day selection aligned to the active week.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/server/meals.ts`, `src/routes/_authed/meals/-meals.test.tsx`, `src/server/meals.test.ts`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: `getMeals` accepts optional week filters via `inputValidator` and expects `{ data: {} }` when no filters are passed.
  - Gotchas encountered: RTL queries for the add flow should use `findAllByRole` once multiple "Add Meal" buttons exist.
  - Useful context: Browser check confirmed week navigation controls render on `/meals`.
---
## 2026-01-16 18:20 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added edit mode for meal cards with a shared add/edit form, update mutation wiring, and edit coverage in UI tests.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-meals.test.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: `npx tsc --noEmit` currently fails due to unrelated type errors in `src/components/Header.tsx` and `src/components/ui/resizable.tsx`.
  - Useful context: Edit form reuses the add form layout and swaps labels/actions based on `formMode`.
---
## 2026-01-16 18:35 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Fixed unrelated typecheck errors in the header icon imports and resizable panel wrappers to unblock `tsc --noEmit`.
- Files changed: `src/components/Header.tsx`, `src/components/ui/resizable.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: `react-resizable-panels` exports `Group` and `Separator` components (not `PanelGroup`/`PanelResizeHandle`).
  - Gotchas encountered: None.
  - Useful context: Typecheck now passes with the updated resizable exports.
---
## 2026-01-16 18:50 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Marked browser verification complete in the PRD per user request.
- Files changed: `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: Browser automation can be flaky due to overlayed navigation; consider manual verification when it blocks automation.
  - Useful context: Dev server was running at `http://localhost:3000/meals` during attempted verification.
---
## 2026-01-16 18:55 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Marked US-006 `passes: true` after confirming all acceptance criteria are checked.
- Files changed: `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: None.
  - Useful context: US-006 status in PRD now reflects completion.
---
## 2026-01-16 21:38 - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Moved meal add/edit into dedicated routes with a step-based wizard for creation and a touch-friendly edit page using selection cards; updated meal list navigation to route to those pages.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/new.tsx`, `src/routes/_authed/meals/$mealId.edit.tsx`, `src/routes/_authed/meals/-meal-form.ts`, `src/routes/_authed/meals/-meals.test.tsx`, `src/routes/_authed/meals/-meal-create-edit.test.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Wizard-style creation flows follow the members new layout with step headers + progress.
  - Gotchas encountered: Loader access to search params requires `loaderDeps` in TanStack Start routes.
  - Useful context: Meal edit routes reuse selection card components for day/type choices.
---
## 2026-01-16 19:16 - US-008
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Ensured add-meal day selection normalizes to the active week, updated tests to assert the stored date, and verified the wizard in the browser.
- Files changed: `src/routes/_authed/meals/new.tsx`, `src/routes/_authed/meals/-meal-form.ts`, `src/routes/_authed/meals/-meal-create-edit.test.tsx`, `docs/prds/MEALS_PRD.md`, `docs/AGENTS.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Use `getWeekDates`/`getDayKey` from `src/utils/date.ts` for week/date mapping logic.
  - Gotchas encountered: None.
  - Useful context: Meal wizard day cards show the week-start range from the `weekStart` search param.
---
## 2026-01-16 20:30 - US-009
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Removed redundant query fetching from the meal edit page to keep meal data managed in the meals feature flow.
- Files changed: `src/routes/_authed/meals/$mealId.edit.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Loader-provided meal data is sufficient for the edit page; avoid double fetching with a second query.
  - Gotchas encountered: None.
  - Useful context: Meal edit mutations still invalidate the shared `["meals"]` query key for list refresh.
---
## 2026-01-17 04:15 - US-010
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added a bottom-sheet wizard on the week view to search recent meals, pick day/type, and add the selected meal to the week; added tests for the new flow.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-meals.test.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Use the `Sheet` component for bottom-sheet flows on mobile.
  - Gotchas encountered: Meal list tests need `cleanup()` between renders to avoid duplicated buttons.
  - Useful context: Meal search uses `getMealNameSuggestions` with recent-first behavior.
---
## 2026-01-16 21:03 - US-011
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added shopping list generation dialog on the meals week view, created server logic to parse meal notes into shopping items, and added UI tests for the flow.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-meals.test.tsx`, `src/server/shopping.ts`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Shopping list generation expects meal IDs and parses notes into items server-side.
  - Gotchas encountered: Default shopping category should align with the shopping UI options (currently "Other").
  - Useful context: The dialog preselects all meals in the active week so users can deselect quickly.
---
## 2026-01-16 21:22 - Meals Shopping Updates
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Moved the shopping list dialog into a dedicated component, added toast + navigation on generate, and wired the shopping page to server-backed CRUD with tests.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-shopping-list-dialog.tsx`, `src/routes/_authed/shopping.tsx`, `src/routes/_authed/shopping.test.tsx`, `src/server/shopping.ts`, `src/routes/_authed/meals/-meals.test.tsx`, `src/routes/__root.tsx`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: `getShoppingItems()` is a no-arg server query suitable for TanStack Query.
  - Gotchas encountered: Use `inputValidator` (not `.validator`) with `createServerFn` in this codebase.
  - Useful context: Shopping list success feedback now uses sonner toasts and navigates to `/shopping`.
---
## 2026-01-19 10:00 - US-012
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added a week-scoped meals query on the dashboard and displayed the planned count on the "Meals This Week" card with loading/empty handling.
- Files changed: `src/routes/_authed/index.tsx`, `src/routes/_authed/-index.test.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: None.
  - Useful context: Dashboard meal count uses `getMeals` with week start/end ISO dates.
---
## 2026-01-19 21:15 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added household-scoped calendar event CRUD with date-range queries, validation, and response mapping, plus unit coverage and context updates for query invocation.
- Files changed: `src/server/calendar.ts`, `src/server/calendar.test.ts`, `src/contexts/CalendarContext.tsx`, `docs/prds/EVENTS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: None.
  - Useful context: Calendar events now include optional `endDate` in server responses.
---
## 2026-01-19 21:25 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added date-range and participant filtering for calendar events with TanStack Query, plus loading/error UI and coverage for filters and rendering.
- Files changed: `src/routes/_authed/calendar/index.tsx`, `src/routes/_authed/calendar/index.test.tsx`, `docs/prds/EVENTS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Date-range filters in calendar UI pass start/end ISO strings and optional participantId into `getCalendarEvents`.
  - Gotchas encountered: Calendar events render in both the main list and upcoming panel, so RTL assertions should use `*AllBy*` queries.
  - Useful context: Browser check loaded `/calendar` and showed date range inputs plus member filter cards (screenshot capture failed).
---
## 2026-01-19 22:10 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added reusable calendar UI primitives and refactored the calendar route to use shared shell, event cards, and agenda list components with coverage.
- Files changed: `src/components/calendar/AgendaList.tsx`, `src/components/calendar/CalendarDayColumn.tsx`, `src/components/calendar/CalendarEventCard.tsx`, `src/components/calendar/CalendarEventCard.test.tsx`, `src/components/calendar/CalendarGrid.tsx`, `src/components/calendar/CalendarHeader.tsx`, `src/components/calendar/CalendarShell.tsx`, `src/components/calendar/index.ts`, `src/routes/_authed/calendar/index.tsx`, `docs/prds/EVENTS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Calendar UI primitives are centralized under `src/components/calendar`.
  - Gotchas encountered: None.
  - Useful context: Verified the calendar view renders with the new shell, event cards, and upcoming list on `/calendar`.
---
## 2026-01-19 22:45 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added daily/weekly/monthly calendar views with a view switcher, date navigation, and month grid indicators; updated calendar rendering and tests to align with view-based ranges.
- Files changed: `src/routes/_authed/calendar/index.tsx`, `src/routes/_authed/calendar/index.test.tsx`, `docs/prds/EVENTS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: View ranges derived from a single `viewDate` keep query ranges aligned with day/week/month switches.
  - Gotchas encountered: Calendar view tests should use dates within the active week because weekly views render only visible days.
  - Useful context: Verified the calendar view switcher and date controls on `/calendar`, including the monthly tab toggle.
---
## 2026-01-19 23:30 - Calendar UX Refresh
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Removed focus date controls and upcoming events, defaulted views to today, moved member filters into a left column, and added hourly grid layouts for day/week views.
- Files changed: `src/routes/_authed/calendar/index.tsx`, `src/routes/_authed/calendar/index.test.tsx`, `docs/prds/EVENTS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Hourly grids render cleanly by pairing a time column with per-day columns in a CSS grid.
  - Gotchas encountered: None.
  - Useful context: Verified Day/Week/Month tabs and member column on `/calendar`; screenshot capture failed in automation.
---
## 2026-01-30 12:00 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added Convex schema mirroring the Prisma data models with enum validators and indexes, and added the Convex dependency.
- Files changed: `convex/schema.ts`, `package.json`, `package-lock.json`, `docs/prd/prd-migrate-to-convex.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Convex schema uses `defineSchema`/`defineTable` with `v.union` enums and explicit index definitions to mirror Prisma models.
  - Gotchas encountered: None.
  - Useful context: Date fields are represented as numeric timestamps to model Prisma DateTime fields.
---
## 2026-01-30 15:56 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Wired Convex client/query integration, replaced server data access with Convex functions, updated tests and docs for Convex env usage.
- Files changed: `src/routes/__root.tsx`, `src/router.tsx`, `src/server/convex.ts`, `src/server/clerk.ts`, `convex/schema.ts`, `convex/households.ts`, `convex/tasks.ts`, `convex/meals.ts`, `convex/shopping.ts`, `convex/calendar.ts`, `convex/lib/ids.ts`, `convex/lib/household.ts`, `src/server/household.ts`, `src/server/tasks.ts`, `src/server/meals.ts`, `src/server/shopping.ts`, `src/server/calendar.ts`, `src/server/meals.test.ts`, `src/server/calendar.test.ts`, `src/components/calendar/CalendarEventCard.test.tsx`, `src/routes/_authed/calendar/-index.test.tsx`, `docs/system/DATABASE.md`, `docs/prd/prd-migrate-to-convex.md`
- **Learnings for future iterations:**
  - Patterns discovered: Convex server functions centralize household scoping via `convex/lib/household`.
  - Gotchas encountered: Convex dev must run once to generate `convex/_generated` before tests.
  - Useful context: Convex React Query integration lives in `src/router.tsx` with provider wiring in `src/routes/__root.tsx`.
---