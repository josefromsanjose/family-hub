## Codebase Patterns
- Use `getCurrentUserHouseholdId` from `src/server/household.ts` for household-scoped server logic.
- For filtered read server functions, use `inputValidator` and pass `{ data: {} }` when no filters are needed.
- `createServerFn` uses `.inputValidator`, not `.validator`, for input checks.
- `react-resizable-panels` exports `Group`/`Separator` (not `PanelGroup`/`PanelResizeHandle`) in this codebase.
- Reuse `getWeekDates`/`getDayKey` from `src/utils/date.ts` for week/day calculations.

## 2026-01-15 23:59 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added meal CRUD server functions with validation and household scoping.
- Files changed: `src/server/meals.ts`, `src/server/household.ts`, `docs/prds/MEALS_PRD.md`
- **Learnings for future iterations:**
  - Patterns discovered: Meal server functions follow the Tasks pattern with input validators and response mapping.
  - Gotchas encountered: Export the household helper instead of re-creating it in feature server modules.
  - Useful context: Meal responses use ISO date strings for frontend consumption.
---
## 2026-01-16 12:00 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Marked household helper reuse story complete; confirmed helper is defined in `src/server/household.ts` and used by meal server functions.
- Files changed: `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: `getCurrentUserHouseholdId` is the shared helper for household scoping across server modules.
  - Gotchas encountered: Ensure PRD stories include a `passes:` line when marking completion.
  - Useful context: Household membership lookup uses `clerkUserId` in `householdMember`.
---
## 2026-01-16 00:34 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Replaced local meal state with TanStack Query fetches/mutations, added loading/error UI, and wired add/delete to server functions.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-meals.test.tsx`, `docs/prds/MEALS_PRD.md`
- **Learnings for future iterations:**
  - Patterns discovered: For TanStack Query mutations, `createServerFn` receives an extra metadata argument in tests.
  - Gotchas encountered: Meal form labels need `htmlFor`/`id` pairing for RTL queries.
  - Useful context: Browser verification redirected to sign-in at `/sign-in?redirect=%2Fmeals`, so UI verification was blocked without credentials.
---
## 2026-01-16 11:55 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Switched meal day handling to use week-based Date objects, store local start-of-day ISO strings, and match meals by date keys; updated tests to use current-week dates.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-meals.test.tsx`, `docs/prds/MEALS_PRD.md`
- **Learnings for future iterations:**
  - Patterns discovered: Meal week rows derive from `startOfWeek(..., { weekStartsOn: 1 })` + `addDays` with local `startOfDay`.
  - Gotchas encountered: Meal rendering now depends on current-week dates, so tests should generate dates from `startOfWeek(new Date())` to stay deterministic.
  - Useful context: Browser verification still redirects to sign-in without credentials, blocking UI validation.
---
## 2026-01-16 11:58 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Verified the Meal Planning UI in the browser, confirmed weekday dropdown shows Monday-Sunday and add form fields render alongside the weekly grid.
- Files changed: `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Meal Planning UI renders add form inline below the header and uses accessible labels for Day/Meal Type/Meal Name.
  - Gotchas encountered: None.
  - Useful context: Browser verification passed at `/meals` with the current session.
---
## 2026-01-16 18:00 - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added week navigation with range label, scoped meal queries to the selected week, and kept add form day selection aligned to the active week.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/server/meals.ts`, `src/routes/_authed/meals/-meals.test.tsx`, `src/server/meals.test.ts`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: `getMeals` accepts optional week filters via `inputValidator` and expects `{ data: {} }` when no filters are passed.
  - Gotchas encountered: RTL queries for the add flow should use `findAllByRole` once multiple "Add Meal" buttons exist.
  - Useful context: Browser check confirmed week navigation controls render on `/meals`.
---
## 2026-01-16 18:20 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added edit mode for meal cards with a shared add/edit form, update mutation wiring, and edit coverage in UI tests.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-meals.test.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: `npx tsc --noEmit` currently fails due to unrelated type errors in `src/components/Header.tsx` and `src/components/ui/resizable.tsx`.
  - Useful context: Edit form reuses the add form layout and swaps labels/actions based on `formMode`.
---
## 2026-01-16 18:35 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Fixed unrelated typecheck errors in the header icon imports and resizable panel wrappers to unblock `tsc --noEmit`.
- Files changed: `src/components/Header.tsx`, `src/components/ui/resizable.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: `react-resizable-panels` exports `Group` and `Separator` components (not `PanelGroup`/`PanelResizeHandle`).
  - Gotchas encountered: None.
  - Useful context: Typecheck now passes with the updated resizable exports.
---
## 2026-01-16 18:50 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Marked browser verification complete in the PRD per user request.
- Files changed: `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: Browser automation can be flaky due to overlayed navigation; consider manual verification when it blocks automation.
  - Useful context: Dev server was running at `http://localhost:3000/meals` during attempted verification.
---
## 2026-01-16 18:55 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Marked US-006 `passes: true` after confirming all acceptance criteria are checked.
- Files changed: `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: None.
  - Gotchas encountered: None.
  - Useful context: US-006 status in PRD now reflects completion.
---
## 2026-01-16 21:38 - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Moved meal add/edit into dedicated routes with a step-based wizard for creation and a touch-friendly edit page using selection cards; updated meal list navigation to route to those pages.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/new.tsx`, `src/routes/_authed/meals/$mealId.edit.tsx`, `src/routes/_authed/meals/-meal-form.ts`, `src/routes/_authed/meals/-meals.test.tsx`, `src/routes/_authed/meals/-meal-create-edit.test.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Wizard-style creation flows follow the members new layout with step headers + progress.
  - Gotchas encountered: Loader access to search params requires `loaderDeps` in TanStack Start routes.
  - Useful context: Meal edit routes reuse selection card components for day/type choices.
---
## 2026-01-16 19:16 - US-008
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Ensured add-meal day selection normalizes to the active week, updated tests to assert the stored date, and verified the wizard in the browser.
- Files changed: `src/routes/_authed/meals/new.tsx`, `src/routes/_authed/meals/-meal-form.ts`, `src/routes/_authed/meals/-meal-create-edit.test.tsx`, `docs/prds/MEALS_PRD.md`, `docs/AGENTS.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Use `getWeekDates`/`getDayKey` from `src/utils/date.ts` for week/date mapping logic.
  - Gotchas encountered: None.
  - Useful context: Meal wizard day cards show the week-start range from the `weekStart` search param.
---
## 2026-01-16 20:30 - US-009
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Removed redundant query fetching from the meal edit page to keep meal data managed in the meals feature flow.
- Files changed: `src/routes/_authed/meals/$mealId.edit.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Loader-provided meal data is sufficient for the edit page; avoid double fetching with a second query.
  - Gotchas encountered: None.
  - Useful context: Meal edit mutations still invalidate the shared `["meals"]` query key for list refresh.
---
## 2026-01-17 04:15 - US-010
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added a bottom-sheet wizard on the week view to search recent meals, pick day/type, and add the selected meal to the week; added tests for the new flow.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-meals.test.tsx`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Use the `Sheet` component for bottom-sheet flows on mobile.
  - Gotchas encountered: Meal list tests need `cleanup()` between renders to avoid duplicated buttons.
  - Useful context: Meal search uses `getMealNameSuggestions` with recent-first behavior.
---
## 2026-01-16 21:03 - US-011
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added shopping list generation dialog on the meals week view, created server logic to parse meal notes into shopping items, and added UI tests for the flow.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-meals.test.tsx`, `src/server/shopping.ts`, `docs/prds/MEALS_PRD.md`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: Shopping list generation expects meal IDs and parses notes into items server-side.
  - Gotchas encountered: Default shopping category should align with the shopping UI options (currently "Other").
  - Useful context: The dialog preselects all meals in the active week so users can deselect quickly.
---
## 2026-01-16 21:22 - Meals Shopping Updates
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Moved the shopping list dialog into a dedicated component, added toast + navigation on generate, and wired the shopping page to server-backed CRUD with tests.
- Files changed: `src/routes/_authed/meals/index.tsx`, `src/routes/_authed/meals/-shopping-list-dialog.tsx`, `src/routes/_authed/shopping.tsx`, `src/routes/_authed/shopping.test.tsx`, `src/server/shopping.ts`, `src/routes/_authed/meals/-meals.test.tsx`, `src/routes/__root.tsx`, `docs/progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered: `getShoppingItems()` is a no-arg server query suitable for TanStack Query.
  - Gotchas encountered: Use `inputValidator` (not `.validator`) with `createServerFn` in this codebase.
  - Useful context: Shopping list success feedback now uses sonner toasts and navigates to `/shopping`.
---